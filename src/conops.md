## 2. CONOPS (Concept of Operation)

### Участники (стейкхолдеры/роли)

1. **Инициатор** — сотрудник, который создаёт документ (заявку, договор, служебную записку) и запускает его по маршруту согласования.
2. **Согласующий** — руководитель или ответственный сотрудник, который должен утвердить или отклонить документ.
3. **Юрист** — специалист юридического отдела, проверяющий документы на соответствие законодательству и внутренним нормативам (комплаенс).
4. **Бухгалтер** — сотрудник финансового отдела, работающий с заявками на оплату и финансовыми условиями договоров.
5. **Администратор** — специалист IT/HR, настраивающий маршруты, права доступа, справочники и шаблоны.
6. **Контрагент** — внешняя организация (сторона по договору), взаимодействует через оператора ЭДО (электронного документооборота).

### Системные элементы (типовая конфигурация)

1. **Маршрутизатор** (Workflow Engine) — ядро системы, управляющее движением задач по ролям и контролем сроков (SLA).
2. **Репозиторий документов** — хранилище файлов с поддержкой версионности (VCS — Version Control System), хранит историю изменений.
3. **Модуль КЭП/УНЭП** — интеграция с криптопровайдером (УЦ — удостоверяющий центр) для наложения электронных подписей. КЭП — квалифицированная электронная подпись, УНЭП — усиленная неквалифицированная электронная подпись.
4. **Журнал аудита** (Audit Log) — неизменяемая лента событий для юридической значимости.
5. **Сервис уведомлений** — отправка Email / Push / SMS через внешний шлюз.
6. **Модуль аутентификации (SSO)** — подсистема единого входа (Single Sign-On). Интегрируется с корпоративным каталогом (Active Directory / LDAP): при входе пользователя запрашивает у каталога проверку учётных данных и получает в ответ токен, роли и группы. Все остальные модули платформы доверяют этому токену и не запрашивают пароль повторно. Если корпоративный каталог недоступен, Администратор может переключить модуль в режим ручной аутентификации (см. режимы деградации).
7. **Справочник оргструктуры** — кэшированная база сотрудников, ролей и иерархии. Периодически синхронизируется с HR-системой. Для определения ролей и замещений Маршрутизатор обращается именно к этому справочнику, а не напрямую к внешним системам.
8. **Модуль ЭДО** — обмен юридически значимыми документами с контрагентами через внешнего оператора ЭДО (роуминг).
9. **Модуль архивации** — передача завершённых дел в долговременный архив (по ФЗ-125, хранение 5+ лет).

---

### Сценарий 1. Запуск договора на согласование (Инициатор → Юрист → Согласующий → Контрагент)

#### Цель

1. Создать договор с контрагентом, провести юридическую экспертизу и бизнес-утверждение с контролем версий, затем направить контрагенту на подпись через ЭДО.

#### Условия начала

1. Инициатор авторизован в платформе через Модуль аутентификации (SSO) — получен токен с ролями.
2. Справочник оргструктуры актуален (известны роли Юриста и Согласующего).
3. Реквизиты контрагента проверены через ERP (статус активен).
4. Шаблон договора доступен для загрузки.

#### Основной поток (Happy path)

1. Инициатор создаёт карточку договора, заполняет реквизиты (контрагент, сумма, предмет) и загружает файл (Версия 1).
2. Маршрутизатор обращается к Справочнику оргструктуры, определяет маршрут: первый шаг — Юрист.
3. Юрист получает уведомление (через Сервис уведомлений), открывает задачу, вносит правки, загружает Версию 1.1 с пометкой «Правки юриста».
4. Репозиторий документов сохраняет обе версии, связывая их с одной карточкой.
5. Юрист нажимает «Согласовано», задача переходит к Согласующему.
6. Согласующий видит разницу версий, утверждает файл и накладывает КЭП через Модуль КЭП/УНЭП.
7. Модуль подписи фиксирует подпись, Журнал аудита сохраняет событие (кто, когда, IP, хеш файла, сертификат).
8. Модуль ЭДО направляет подписанный документ Контрагенту через внешнего оператора ЭДО.
9. Контрагент подписывает встречной КЭП. Оператор ЭДО возвращает квитанцию и подписанный экземпляр.
10. Инициатор получает уведомление: «Договор подписан обеими сторонами».
11. Модуль архивации передаёт завершённое дело в долговременный архив.

#### Результат

1. Договор подписан КЭП обеими сторонами, все версии сохранены, аудиторский след сформирован, документ в архиве.

#### Исключения (нештатные ситуации)

1. **Юрист отклонил договор**
   1.1. Юрист пишет причину отказа (например, «Неверная форма собственности контрагента»).
   1.2. Маршрутизатор возвращает задачу Инициатору на доработку.
   1.3. Статус документа меняется на «Доработка».
2. **Конфликт версий** (параллельное редактирование)
   2.1. Юрист и Согласующий сохранили свои версии параллельно (Версия 1.1 и 1.2).
   2.2. Репозиторий документов фиксирует конфликт.
   2.3. Тот, кто нажимает «Согласовать» позже, видит предупреждение: «Файл был изменён. Загрузите актуальную версию или разрешите конфликт вручную».
3. **Нет прав на подписание у Согласующего**
   3.1. Модуль КЭП/УНЭП проверяет сертификат ЭП (через OCSP — протокол проверки статуса сертификата). Если недействителен — кнопка «Подписать» блокируется, предлагается перевыпуск или делегирование заместителю.
4. **Контрагент отклонил документ**
   4.1. Оператор ЭДО передаёт протокол разногласий. Маршрутизатор возвращает задачу Инициатору/Юристу.
5. **Реквизиты контрагента не найдены в ERP**
   5.1. Система блокирует отправку до заведения контрагента в справочнике.

#### Режимы деградации (как продолжаем работать)

1. **Модуль КЭП/УНЭП недоступен** (криптопровайдер не отвечает)
   1.1. Документ переходит в статус «Ожидание подписи (оффлайн)».
   1.2. Согласующий может проставить визу (внутреннюю отметку), но юридически документ не подписан.
   1.3. При восстановлении — документ ставится в очередь на подписание.
2. **Корпоративный каталог (AD/LDAP) не отвечает** — затрагивает и SSO, и Справочник оргструктуры
   2.1. Модуль аутентификации: уже авторизованные пользователи продолжают работать по действующему токену. Новые входы невозможны, пока Администратор не включит ручную аутентификацию.
   2.2. Справочник оргструктуры: Маршрутизатор использует кэшированную копию (вчерашняя выгрузка). Задачи назначаются по ролям, а не по ФИО.
   2.3. При восстановлении — синхронизация.
3. **Оператор ЭДО недоступен**
   3.1. Документ в статусе «Ожидание отправки», автоматическая отправка при восстановлении.

---

### Сценарий 2. Срочное согласование служебной записки (мобильный доступ)

#### Цель

1. Согласовать срочную служебную записку (например, на выдачу материальных ценностей) в нерабочее время через мобильное устройство.

#### Условия начала

1. Сотрудники вне офиса, используется мобильное приложение.
2. Инициатор авторизован через Модуль аутентификации (SSO) — токен действующий.

#### Основной поток

1. Инициатор создаёт служебную записку, прикрепляет скан-копии (фото с телефона).
2. Маршрутизатор через Справочник оргструктуры определяет маршрут: Согласующий (руководитель), Бухгалтер — только если сумма выше лимита.
3. Согласующий получает push-уведомление (через Сервис уведомлений), открывает документ на смартфоне.
4. Согласующий нажимает «Согласовать» (простая ЭП или УНЭП через SMS-код, если КЭП не требуется).
5. Сумма ниже порога бухгалтерии — маршрут завершается.
6. Инициатор и Бухгалтер (для сведения) получают уведомление.

#### Результат

1. Служебная записка утверждена руководителем в условиях мобильного UI.

#### Исключения

1. **Медленный интернет / обрыв связи**
   1.1. Приложение работает в оффлайн-режиме: сохраняет черновик локально.
   1.2. Решение помещается в очередь.
   1.3. При восстановлении — синхронизация с пометкой в Журнале аудита «Подписано в оффлайн-режиме».
2. **Документ требует КЭП, но на устройстве нет сертификата**
   2.1. Модуль КЭП/УНЭП не находит сертификат. Система предлагает «Отложенную подпись»: задача бронируется, требуется подтверждение с рабочего ПК в течение 24 часов, либо УНЭП через SMS-код.

#### Режимы деградации

1. **Сервис уведомлений / шлюз недоступен**
   1.1. Push не доставлен. Платформа повторяет через альтернативный канал (SMS → Email).
2. **Модуль аутентификации (SSO) недоступен**
   2.1. Мобильное приложение использует кэшированный токен, если сессия активна. При истечении токена — вход невозможен до восстановления.

---

### Сценарий 3. Заявка на оплату (Бухгалтерия и контроль лимитов)

#### Цель

1. Провести заявку на оплату счёта через бухгалтерию с проверкой бюджетных лимитов и корректности заполнения.

#### Условия начала

1. Заявка создана на основании утверждённого договора.
2. В системе настроены бюджетные лимиты по статьям расходов (интеграция с ERP).

#### Основной поток

1. Инициатор заполняет заявку: ссылка на договор, сумма, статья расходов, скан счёта.
2. Маршрутизатор автоматически запрашивает ERP: остаток бюджета по статье, лимит договора, реквизиты контрагента.
3. Если лимиты позволяют — заявка уходит Бухгалтеру.
4. Бухгалтер проверяет реквизиты (ИНН, КПП, расчётный счёт, назначение платежа).
5. Бухгалтер нажимает «Исполнить» или «Передать в платёжную систему».
6. Система фиксирует оплату и списывает сумму из лимита в ERP.

#### Результат

1. Заявка обработана, лимиты скорректированы.

#### Исключения

1. **Превышение бюджетного лимита**
   1.1. Система не позволяет отправить Бухгалтеру.
   1.2. Маршрутизатор через Справочник оргструктуры находит вышестоящего руководителя или финдиректора и добавляет в цепочку (эскалация).
   1.3. Заявка в статусе «Ожидание бюджета».
2. **Реквизиты контрагента не найдены**
   2.1. Система блокирует отправку, пока контрагент не будет заведён в ERP/CRM.

#### Режимы деградации

1. **Интеграция с ERP недоступна**
   1.1. Модуль проверки лимитов переходит в ручной режим.
   1.2. Бухгалтер получает задачу с пометкой «Проверить лимиты вручную».
   1.3. Бухгалтер чекбоксом подтверждает, что лимит есть (берёт ответственность на себя), и проводит заявку.

---

### Сценарий 4. Коллегиальное согласование (параллельный маршрут + голосование)

#### Цель

1. Согласовать стратегический документ (Политику, Положение), требующий одобрения нескольких руководителей одновременно.

#### Условия начала

1. Создан документ, требующий визирования: Юрист, HR-директор, Техдиректор, Финдиректор.
2. Маршрут параллельного согласования настроен Администратором.

#### Основной поток

1. Инициатор запускает задачу на параллельное согласование.
2. Маршрутизатор через Справочник оргструктуры находит всех Согласующих и создаёт им задачи одновременно.
3. Каждый получает уведомление (через Сервис уведомлений), видит документ и голосует: «За» / «Против» / «Воздержался».
4. Маршрутизатор агрегирует голоса по правилу (единогласно / большинство).
5. Допустим, Юрист — против. Результат: «Не согласовано. Юрист против».
6. Инициатор получает уведомление с протоколом разногласий.

#### Результат

1. Документ отклонён с фиксацией позиции каждого участника в Журнале аудита.

#### Исключения

1. **Тайм-аут ожидания голосов** (контроль сроков)
   1.1. Сервис уведомлений отправляет напоминания (SLA). Если к дедлайну проголосовало 2 из 3, система применяет политику «Молчание — знак согласия» (если настроено) или фиксирует кворум (>50%).
2. **Голосование «За, с замечаниями»**
   2.1. Комментарий прикрепляется к документу в Репозитории.
   2.2. Если кто-то «Против» с блокирующими правками — задача возвращается Инициатору, остальные голоса помечаются как неактуальные.

#### Режимы деградации

1. **Справочник оргструктуры устарел** (HR-система не отвечает, не удаётся найти заместителей)
   1.1. Используется кэшированная копия, задачи назначаются по роли, а не по ФИО.
2. **Сервис уведомлений недоступен**
   2.1. Напоминания SLA не отправляются. Задачи доступны при входе в платформу. При восстановлении — массовая рассылка.

---

### Сценарий 5. Аудит и разбирательство (юридическая значимость)

#### Цель

1. Восстановить полную картину событий по договору в случае судебного спора или проверки контролирующими органами (ФНС, внешний аудит).

#### Условия начала

1. Юрист или Администратор имеет право на просмотр Журнала аудита (права настроены Администратором).

#### Основной поток

1. Юрист открывает карточку спорного договора. Если документ в архиве — Модуль архивации запрашивает его из долговременного хранилища.
2. Переходит на вкладку «Аудит». Система отображает неизменяемую ленту из Журнала аудита:
    - `01.02 10:00` — Иванов И.И. (Инициатор) загрузил version_1.docx (Хеш: A12F)
    - `01.02 14:20` — Петрова А. (Юрист) загрузила version_2.docx (Хеш: B34C). Комментарий: «Поправил п.3.2»
    - `02.02 09:00` — Сидоров (Согласующий) ПОДПИСАЛ КЭП. Хеш: B34C. Сертификат: №567
    - `03.02 11:00` — Документ направлен Контрагенту через ЭДО. Квитанция: №890
    - `04.02 15:30` — Контрагент подписал встречной КЭП. Хеш: B34C
3. Юрист проверяет подпись: Модуль КЭП/УНЭП обращается к криптопровайдеру (OCSP — проверка статуса сертификата, TSP — метка времени).
4. При необходимости скачивает конкретную версию файла из Репозитория документов по хешу для сверки.
5. Экспортирует Акт аудита в PDF, заверенный системной печатью платформы.

#### Результат

1. Сформирован юридически значимый отчёт, доказывающий цепочку событий.

#### Исключения

1. **Попытка подделать лог в БД**
   1.1. Невозможно по NFR (нефункциональные требования). Журнал аудита использует криптографическое связывание записей (blockchain-like) или WORM-носитель (Write Once Read Many — однократная запись, многократное чтение). Любое изменение нарушает крипто-цепочку и обнаруживается мониторингом.
2. **Сертификат подписи отозван**
   2.1. Модуль КЭП/УНЭП проверяет статус через OCSP. Если сертификат отозван ПОСЛЕ подписания — документ действителен (метка времени TSP спасает). Если ДО — документ ничтожен, аудит фиксирует нарушение.

---

### Таблица «Сценарий → основные сбои → деградация»

| № | Сценарий | Критичный сбой | Деградация (fallback) |
|---|----------|----------------|----------------------|
| 1 | Запуск договора (Юрист → Руководитель → Контрагент) | Конфликт версий при параллельном редактировании | Блокировка сохранения вторым редактором; ручное разрешение конфликта (скачать, объединить, загрузить новую версию) |
| 2 | Согласование служебки (мобайл) | Модуль КЭП недоступен или нет сертификата на устройстве | Режим «Отложенной подписи» (УНЭП/SMS) или бронирование задачи до возврата на ПК |
| 3 | Заявка на оплату | Интеграция с ERP (проверка лимитов) недоступна | Ручной режим: бухгалтер подтверждает лимит чекбоксом, берёт ответственность |
| 4 | Коллегиальное голосование | Тайм-аут ожидания голосов (контроль сроков) | Политика «Молчание — знак согласия» или фиксация решения по кворуму |
| 5 | Аудит действий | Попытка модификации логов (внешний взлом) | Криптографическая связка логов (blockchain-like). Нарушение целостности детектируется, доступ блокируется |
